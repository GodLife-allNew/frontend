name: Deploy React to Nginx Docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Set npm version
        run: corepack enable && corepack prepare npm@11.4.1 --activate

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: CI=false npm run build

      - name: Check build output
        run: |
          ls -la build/
          test -f build/index.html || exit 1

      - name: Copy build files to remote server
        uses: appleboy/scp-action@v0.1.7
        with:
          username: ${{ secrets.EC2_USER }}
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/*"
          target: "/tmp/frontend-deploy"
          strip_components: 1
          overwrite: true

      - name: Deploy to both host and container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 호스트 디렉토리 업데이트 (영속성)
            rm -rf /home/ubuntu/app/nginx/html/*
            cp -r /tmp/frontend-deploy/* /home/ubuntu/app/nginx/html/
            sudo chown -R 101:101 /home/ubuntu/app/nginx/html
            sudo find /home/ubuntu/app/nginx/html -type f -exec chmod 644 {} \;
            sudo find /home/ubuntu/app/nginx/html -type d -exec chmod 755 {} \;
            
            # 컨테이너에 직접 복사 (즉시 적용)
            docker exec nginxserver sh -c "rm -rf /usr/share/nginx/html/*"
            docker cp /tmp/frontend-deploy/. nginxserver:/usr/share/nginx/html/
            docker exec nginxserver sh -c "chown -R nginx:nginx /usr/share/nginx/html && \
                                           find /usr/share/nginx/html -type f -exec chmod 644 {} \; && \
                                           find /usr/share/nginx/html -type d -exec chmod 755 {} \;"
            
            # Nginx 리로드
            docker exec nginxserver nginx -s reload
            
            # 정리
            rm -rf /tmp/frontend-deploy
            
            echo "✅ Deployment complete"

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GODLIFE_SERVER_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Host files ==="
            ls -lh /home/ubuntu/app/nginx/html/ | head -5
            
            echo ""
            echo "=== Container files ==="
            docker exec nginxserver ls -lh /usr/share/nginx/html/ | head -5
            
            echo ""
            echo "=== Health check ==="
            HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" https://localhost/)
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Frontend is accessible!"
            else
              echo "❌ Failed with status $HTTP_CODE"
              exit 1
            fi
